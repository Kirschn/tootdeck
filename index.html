<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript" src="mastodon.js/mastodon.js"></script>
    <title>Tootdeck</title>
    <script>

        // el config
        var clientConfig = {
            "redirect_uri": window.location.href,
            "application_name": "Tootdeck",
            "scopes": [
                "read",
                "write",
                "follow"
            ],
            website: "http://github.com/Kirschn/tootdeck"
        }, api;


        // Storage method function
        // add some ajax functions or whatever if you don't trust the local browser storage
        var initLocalStorage = function (storeMethod) {
            if (storeMethod === undefined) {
                storeMethod = "localStorage";
            }
            if (storeMethod === "localStorage") {
                return {
                    setItem: function (key, content) {
                        return localStorage.setItem(key, content)
                    },
                    getItem: function (key) {
                        return localStorage.getItem(key);
                    }
                }
            }
        };
        var varStorage = new initLocalStorage("localStorage");

        if (window.location.href.indexOf("?code=") !== -1) {

            api = new MastodonAPI({
                instance: varStorage.getItem("domain")
            });
            // nice, we got our auth code!
            // lets put it into a variable

            var authCode = window.location.href.replace(window.location.origin + window.location.pathname + "?code=", "");
            // nice variable clusterfuck, eh?
            // we have everything needed to access our oauth token
            api.getAccessTokenFromAuthCode(
                varStorage.getItem("client_id"),
                varStorage.getItem("client_secret"),
                varStorage.getItem("client_redirect_uri"),
                authCode,
                function(data) {
                    // AAAND DATA CONTAINS OUR TOKEN!
                    // use api.setConfig("api_user_token", tokenvar) to set it without having to reinit the entire
                    // library.
                    console.log(data);
                    // set oauth token to cache
                    varStorage.setItem("oauth_token", data["access_token"]);
                    //and remove it from the url bar, just because of security
                    window.history.pushState("", "", window.location.origin + window.location.pathname);
                }

            )
        }

        // check if we're authenticated and have an application
        if (varStorage.getItem("oauth_token") === null) {
            var instanceURL = window.prompt("please gimme your mastodon instance domain", "https://pleasehug.me");
            if (instanceURL === null || instanceURL === "") {
                //window.location.href="https://pleasehug.me";
            } else {
                varStorage.setItem("domain", instanceURL);
                    api = new MastodonAPI({
                        instance: instanceURL
                    });
                    api.registerApplication(clientConfig.application_name,
                    clientConfig.redirect_uri,
                    clientConfig.scopes,
                    clientConfig.website, function (data) {
                        varStorage.setItem("client_id", data["client_id"]);
                        varStorage.setItem("client_secret", data["client_secret"]);
                        varStorage.setItem("client_redirect_uri", data["redirect_uri"]);
                        console.log(data);
                        window.location.href = api.generateAuthLink(data["client_id"],
                            data["redirect_uri"],
                            "code", // oauth method
                            clientConfig.scopes //scopes
                        );
                    });
            }


        }

    </script>
</head>
<body>

</body>
</html>