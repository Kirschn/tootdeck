<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript" src="mastodon.js/mastodon.js"></script>
    <title>Tootdeck</title>
    <script>

        // el config
        var clientConfig = {
            "redirect_uri": window.location.href,
            "application_name": "Tootdeck",
            "scopes": [
                "read",
                "write",
                "follow"
            ],
            website: "http://github.com/Kirschn/tootdeck"
        }, api;


        // Storage method function
        // add some ajax functions or whatever if you don't trust the local browser storage
        var initLocalStorage = function (storeMethod) {
            if (storeMethod === undefined) {
                storeMethod = "localStorage";
            }
            if (storeMethod === "localStorage") {
                return {
                    setItem: function (key, content) {
                        return localStorage.setItem(key, content)
                    },
                    getItem: function (key) {
                        return localStorage.getItem(key);
                    }
                }
            }
        };
        var varStorage = new initLocalStorage("localStorage");

        if (window.location.href.indexOf("?code=") !== -1) {

            api = new MastodonAPI({
                instance: varStorage.getItem("domain")
            });
            // nice, we got our auth code!
            // lets put it into a variable

            var authCode = window.location.href.replace(window.location.origin + window.location.pathname + "?code=", "");
            // nice variable clusterfuck, eh?
            // we have everything needed to access our oauth token
            api.getAccessTokenFromAuthCode(
                varStorage.getItem("client_id"),
                varStorage.getItem("client_secret"),
                varStorage.getItem("client_redirect_uri"),
                authCode,
                function(data) {
                    // AAAND DATA CONTAINS OUR TOKEN!
                    // use api.setConfig("api_user_token", tokenvar) to set it without having to reinit the entire
                    // library.
                    console.log(data);
                    // set oauth token to cache
                    varStorage.setItem("oauth_token", data["access_token"]);
                    //and remove it from the url bar, just because of security
                    window.history.pushState("", "", window.location.origin + window.location.pathname);
                    api.setConfig("api_user_token", data["access_token"]);
                }

            )
        }

        // check if we're authenticated and have an application
        if (varStorage.getItem("oauth_token") === null) {
            var instanceURL = window.prompt("please gimme your mastodon instance domain", "https://pleasehug.me");
            if (instanceURL === null || instanceURL === "") {
                //window.location.href="https://pleasehug.me";
            } else {
                varStorage.setItem("domain", instanceURL);
                    api = new MastodonAPI({
                        instance: instanceURL
                    });
                    api.registerApplication(clientConfig.application_name,
                    clientConfig.redirect_uri,
                    clientConfig.scopes,
                    clientConfig.website, function (data) {
                        varStorage.setItem("client_id", data["client_id"]);
                        varStorage.setItem("client_secret", data["client_secret"]);
                        varStorage.setItem("client_redirect_uri", data["redirect_uri"]);
                        console.log(data);
                        window.location.href = api.generateAuthLink(data["client_id"],
                            data["redirect_uri"],
                            "code", // oauth method
                            clientConfig.scopes //scopes
                        );
                    });
            }


        }
        function generateTimeline(type, localAPI, id, additionalData) {

            // generate basic HTML structure
            var mainTLElement = document.createElement("div");
            mainTLElement.className = "timeline-wrapper";
            mainTLElement.id = "timelineWrapper-" + type + "-" + id;
            var TLWrapper = document.createElement("div");
            mainTLElement.className = "timeline-content";
            mainTLElement.id = "timelineContent-" + type + "-" + id;
            mainTLElement.appendChild(TLWrapper);
            document.getElementById("mainContentBody").appendChild(mainTLElement);
            // start api logic
            if (type === "stream-local") {
                localAPI.stream("public", function (data) {
                    console.log(data);
                    if (data.event === "update") {
                        var aviWrapper = document.createElement("div"),
                            usernameWrapper = document.createElement("div"),
                            tootContentWrapper = document.createElement("div");
                        aviWrapper.className = "avatar-timeline-normal";
                        usernameWrapper.className = "username-timeline-normal";
                        tootContentWrapper.className = "tootcontent-timeline-normal";
                        aviWrapper.innerHTML = "<a><img src='" + data.payload.account.avatar + "'></a>";
                        usernameWrapper.innerHTML = "<a>" + data.payload.account.username + "</a>";
                        tootContentWrapper.innerHTML = "<a>" + data.payload.content + "'</a>";
                        document.getElementById("timelineContent-" + type + "-" + id).appendChild(aviWrapper);
                        document.getElementById("timelineContent-" + type + "-" + id).appendChild(usernameWrapper);
                        document.getElementById("timelineContent-" + type + "-" + id).appendChild(tootContentWrapper);
                    }
                })
            }

        }
        function init() {
            if (typeof api === "undefined") {
                api = new MastodonAPI({
                    instance: varStorage.getItem("domain"),
                    "api_user_token": varStorage.getItem("oauth_token")
                });
            }
            generateTimeline("stream-local", api, "teststream");
        }
    </script>
</head>
<body onload="init()">
    <div id="mainContentBody">

    </div>
</body>
</html>